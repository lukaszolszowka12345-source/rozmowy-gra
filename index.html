<!doctype html>
<html lang="pl">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>Rozmowy — gra w pytania (V2)</title>
  <style>
    :root{--bg:#0b1020;--card:#0f172a;--bar:#111827;--line:#243046;--text:#fff;--m:rgba(255,255,255,.75);--m2:rgba(255,255,255,.55);--good:#22c55e;--danger:#ef4444;}
    html,body{margin:0;height:100%;background:var(--bg);color:var(--text);font-family:system-ui}
    body{display:flex;justify-content:center}
    .app{width:100%;max-width:860px;min-height:100%;display:flex;flex-direction:column}
    header{padding:14px 16px;background:var(--bar);display:flex;align-items:center;justify-content:space-between;gap:12px}
    header .title{flex:1;text-align:center;line-height:1.15}
    header .title b{font-size:18px}
    header .title span{display:block;font-size:12px;opacity:.85}
    main{flex:1;display:flex;align-items:center;justify-content:center;padding:14px}
    .stack{width:100%;display:flex;flex-direction:column;gap:12px;align-items:center}
    .panel{width:100%;background:var(--card);border:1px solid var(--line);border-radius:18px;padding:14px}
    .sep{height:1px;background:var(--line);margin:12px 0}
    .center{text-align:center}
    .chips{display:flex;flex-wrap:wrap;gap:8px;justify-content:center}
    .chip{border:1px solid var(--line);background:#0b132b;color:var(--text);padding:9px 12px;border-radius:999px;font-weight:900;cursor:pointer}
    .chip.active{background:#1f2a44;border-color:#3b4a6a}
    .grid{display:grid;grid-template-columns:1fr;gap:8px;max-width:520px;width:100%;margin:0 auto}
    .label{font-size:12px;color:var(--m);text-align:left}
    input[type="number"],input[type="text"]{width:100%;padding:12px;border-radius:12px;border:1px solid var(--line);background:#0b132b;color:var(--text);font-size:16px;outline:none}
    input::placeholder{color:var(--m2)}
    .row{display:flex;flex-wrap:wrap;gap:10px;align-items:center;justify-content:center}
    .btn{border:0;border-radius:16px;padding:12px 14px;font-weight:900;cursor:pointer;background:var(--good);color:#052e13}
    .btn.secondary{background:#0b132b;color:var(--text);border:1px solid var(--line)}
    .btn.danger{background:var(--danger);color:#fff}
    .btn.big{font-size:22px;padding:16px 18px;border-radius:18px;min-width:min(520px,100%)}
    .btn:disabled{opacity:.45;cursor:not-allowed}
    .hide{display:none!important}
    .card{width:100%;border:1px solid var(--line);border-radius:20px;padding:16px;min-height:170px;display:flex;flex-direction:column;gap:10px;justify-content:center;text-align:center;
      background:linear-gradient(180deg, rgba(255,255,255,.06), rgba(255,255,255,0));}
    .turn{font-size:14px;color:var(--m)}
    .question{font-size:22px;line-height:1.25}
    .small{font-size:12px;color:var(--m2);text-align:center}
    .badge{display:inline-block;font-weight:900;font-size:12px;padding:6px 10px;border-radius:999px;border:1px solid var(--line);background:#0b132b;color:var(--text)}
  </style>
</head>
<body>
<div class="app">
  <header>
    <div style="width:44px"></div>
    <div class="title">
      <b>Rozmowy <span class="badge">WERSJA V2</span></b>
      <span>Gra w pytania • bez wygranych i przegranych</span>
    </div>
    <button class="btn secondary" id="newGameBtn">Nowa gra</button>
  </header>

  <main>
    <div class="stack">

      <section class="panel" id="setup">
        <div class="center">
          <h2 style="margin:0 0 6px 0">Ustawienia</h2>
          <div class="small">1) Wybierz kategorie • 2) Wpisz imiona • 3) Start</div>
        </div>

        <div class="sep"></div>

        <div class="center" style="margin-bottom:8px"><b>Kategorie w grze</b></div>
        <div class="chips" id="setupChips"></div>
        <div class="small" id="setupCatsMeta" style="margin-top:8px"></div>

        <div class="sep"></div>

        <div class="grid">
          <div class="label">Liczba miejsc (max 20)</div>
          <input id="playerCount" type="number" min="2" max="20" value="2"/>

          <div class="label" style="margin-top:6px">Imiona graczy (kolejność ma znaczenie)</div>
          <div id="playersGrid" class="grid"></div>

          <div class="row" style="margin-top:10px">
            <button class="btn big" id="startBtn">START</button>
          </div>

          <div class="small">
            Minimum 2 osoby. Tura: Gracz A losuje pytanie dla Gracza B.<br>
            Każdy gracz ma 2 zmiany pytania na CAŁĄ GRĘ.
          </div>
        </div>
      </section>

      <section class="panel hide" id="play">
        <div class="center">
          <div class="small" id="lockedCatsLine"></div>
          <div class="small" id="poolLine"></div>
        </div>

        <div class="sep"></div>

        <div class="card">
          <div class="turn" id="turnLine">—</div>
          <div class="question" id="questionLine">Kliknij „Losuj pytanie”, żeby zacząć.</div>
          <div class="small" id="otherLine">—</div>
        </div>

        <div class="row" style="margin-top:12px">
          <button class="btn big" id="mainBtn">Losuj pytanie</button>
        </div>

        <div class="row">
          <button class="btn secondary" id="otherBtn" disabled>Inne pytanie</button>
          <button class="btn secondary" id="copyBtn" disabled>Kopiuj</button>
          <button class="btn danger" id="resetQuestionsBtn">Reset pytań</button>
        </div>

        <div class="small">Tip: jeśli pytanie jest za mocne — możecie powiedzieć „pas”.</div>
      </section>

    </div>
  </main>
</div>

<script>
const el = (id) => document.getElementById(id);

// sections
const setupSec = el("setup");
const playSec  = el("play");

// setup UI
const setupChips = el("setupChips");
const setupCatsMeta = el("setupCatsMeta");
const playerCountEl = el("playerCount");
const playersGrid = el("playersGrid");
const startBtn = el("startBtn");

// play UI
const newGameBtn = el("newGameBtn");
const lockedCatsLine = el("lockedCatsLine");
const poolLine = el("poolLine");
const turnLine = el("turnLine");
const questionLine = el("questionLine");
const otherLine = el("otherLine");
const mainBtn = el("mainBtn");
const otherBtn = el("otherBtn");
const copyBtn = el("copyBtn");
const resetQuestionsBtn = el("resetQuestionsBtn");

// 10 x 10 = 100 pytań na kategorię
const STEMS = [
  "Gdy myślisz o „{T}”, co jest dla Ciebie najtrudniejsze do powiedzenia na głos?",
  "W obszarze „{T}” — co w Tobie domaga się większej troski i dlaczego?",
  "W obszarze „{T}” — jaka Twoja potrzeba najczęściej nie jest zauważana?",
  "W obszarze „{T}” — co robisz automatycznie, a chciał(a)byś robić świadomie?",
  "W obszarze „{T}” — jaka jedna mała zmiana dałaby największą ulgę?",
  "W obszarze „{T}” — czego się boisz, że się stanie, jeśli będziesz szczery/szczera?",
  "W obszarze „{T}” — co jest Twoją siłą, a co cieniem tej samej cechy?",
  "W obszarze „{T}” — jak rozpoznajesz, że przekraczasz własne granice?",
  "W obszarze „{T}” — co dziś warto odpuścić, żeby odzyskać spokój?",
  "W obszarze „{T}” — jak wyglądałaby Twoja dojrzała reakcja w trudnej chwili?"
];

const CATS = [
  { key:"relacje", label:"Relacje", themes:["zaufanie","granice","bliskość","komunikacja","konflikt","wsparcie","szacunek","zazdrość","intymność","wybaczenie"] },
  { key:"emocje", label:"Emocje", themes:["złość","smutek","lęk","wstyd","poczucie winy","radość","frustracja","bezradność","ulga","spokój"] },
  { key:"ja", label:"Ja (self)", themes:["wartości","tożsamość","samoocena","wewnętrzny krytyk","akceptacja","potrzeby","sprawczość","autentyczność","perfekcjonizm","odwaga"] },
  { key:"rozwoj", label:"Rozwój", themes:["nawyki","dyscyplina","cele","prokrastynacja","energia","nauka","porażka","cierpliwość","odpuszczanie","priorytety"] },
  { key:"rodzina", label:"Rodzina", themes:["komunikacja","role","granice","tradycje","konflikt","wsparcie","dzieciństwo","wzorce","emocje w domu","tematy tabu"] }
];

function shuffle(arr){
  for (let i=arr.length-1;i>0;i--){
    const j=Math.floor(Math.random()*(i+1));
    [arr[i],arr[j]]=[arr[j],arr[i]];
  }
  return arr;
}
function buildBank(cat){
  const out=[];
  for (const t of cat.themes){
    for (const s of STEMS){
      out.push(s.replaceAll("{T}", t));
    }
  }
  return shuffle(out); // 100 dokładnie
}

const setupState = { selectedCats: new Set(CATS.map(c=>c.key)) };
const game = {
  players: [],
  turnAsker: 0,
  questionActive: false,
  lockedCats: [],
  banks: {},
  bags: {},
  usedCount: 0,
  current: null,
  changesLeft: [] // 2 na CAŁĄ GRĘ per gracz (ten co dostaje pytanie)
};

function setSection(isSetup){
  setupSec.classList.toggle("hide", !isSetup);
  playSec.classList.toggle("hide", isSetup);
}

function updateSetupMeta(){
  const labels = CATS.filter(c=>setupState.selectedCats.has(c.key)).map(c=>c.label);
  setupCatsMeta.textContent = labels.length ? `Wybrane: ${labels.join(", ")}` : `Wybierz przynajmniej jedną kategorię.`;
}

function renderChips(){
  setupChips.innerHTML="";
  for (const cat of CATS){
    const b=document.createElement("button");
    b.className="chip active";
    b.textContent=cat.label;
    b.onclick=()=>{
      setupState.selectedCats.has(cat.key) ? setupState.selectedCats.delete(cat.key) : setupState.selectedCats.add(cat.key);
      b.classList.toggle("active", setupState.selectedCats.has(cat.key));
      updateSetupMeta(); updateStartBtn();
    };
    setupChips.appendChild(b);
  }
  updateSetupMeta();
}

function clamp(n,mn,mx){ return Math.max(mn, Math.min(mx, n)); }

function renderPlayers(){
  playersGrid.innerHTML="";
  const n=clamp(parseInt(playerCountEl.value||"2",10),2,20);
  playerCountEl.value=String(n);
  for (let i=0;i<n;i++){
    const w=document.createElement("div");
    w.innerHTML=`<div class="label">Gracz ${i+1}</div><input type="text" id="p_${i}" placeholder="Imię (np. Łukasz)"/>`;
    playersGrid.appendChild(w);
    w.querySelector("input").addEventListener("input", updateStartBtn);
  }
  updateStartBtn();
}

function getPlayers(){
  const n=clamp(parseInt(playerCountEl.value||"2",10),2,20);
  const out=[];
  for (let i=0;i<n;i++){
    const v=(document.getElementById(\`p_\${i}\`)?.value||"").trim();
    if (v) out.push(v);
  }
  return out;
}

function updateStartBtn(){
  const okPlayers = getPlayers().length >= 2;
  const okCats = setupState.selectedCats.size >= 1;
  startBtn.disabled = !(okPlayers && okCats);
  startBtn.textContent = startBtn.disabled ? "Wpisz min. 2 imiona + wybierz kategorie" : "START";
}

function refillBag(catKey){
  const n = game.banks[catKey].length;
  game.bags[catKey] = shuffle(Array.from({length:n},(_,i)=>i));
}
function remainingTotal(){
  let t=0; for (const k of game.lockedCats) t += (game.bags[k]?.length||0); return t;
}
function activeCats(){
  return game.lockedCats.filter(k => (game.bags[k] && game.bags[k].length>0));
}
function pickCategory(){
  const keys=activeCats(); if(!keys.length) return null;
  return keys[Math.floor(Math.random()*keys.length)];
}
function drawOne(){
  const k=pickCategory(); if(!k) return null;
  const idx=game.bags[k].pop();
  game.usedCount += 1;
  return {catKey:k, idx, text: game.banks[k][idx]};
}
function catLabel(k){ return CATS.find(c=>c.key===k)?.label || k; }

function indices(){
  const askerIdx = game.turnAsker;
  const targetIdx = (game.turnAsker+1) % game.players.length;
  return {askerIdx, targetIdx};
}
function pair(){
  const {askerIdx,targetIdx}=indices();
  return {asker:game.players[askerIdx], target:game.players[targetIdx]};
}

function renderHeader(){
  lockedCatsLine.textContent = `Kategorie (zablokowane): ${game.lockedCats.map(catLabel).join(", ")}`;
  poolLine.textContent = `Pozostało pytań: ${remainingTotal()} • Wykorzystane: ${game.usedCount}`;
}
function renderTurn(){
  const {asker,target}=pair();
  const {targetIdx}=indices();
  const left = game.changesLeft[targetIdx] ?? 0;

  turnLine.textContent = `Teraz: ${asker} losuje pytanie dla ${target}`;
  otherLine.textContent = `Zmiany pytania dla ${target}: ${left}/2`;

  otherBtn.textContent = `Inne pytanie (${left})`;
  otherBtn.disabled = !game.questionActive || left<=0;
  copyBtn.disabled = !game.questionActive;

  mainBtn.textContent = game.questionActive ? "Następny gracz" : "Losuj pytanie";
}

function startGame(){
  const players=getPlayers();
  const cats=Array.from(setupState.selectedCats);
  if(players.length<2 || cats.length<1) return;

  game.players = players;
  game.turnAsker = 0;
  game.questionActive = false;
  game.lockedCats = cats;
  game.banks = {}; game.bags = {};
  game.usedCount = 0;
  game.current = null;
  game.changesLeft = players.map(()=>2);

  for (const k of game.lockedCats){
    const cat=CATS.find(c=>c.key===k);
    game.banks[k]=buildBank(cat);
    refillBag(k);
  }

  setSection(false);
  mainBtn.disabled=false;
  questionLine.textContent="Kliknij „Losuj pytanie”, żeby zacząć.";
  renderHeader(); renderTurn();
}

function nextTurn(){
  game.turnAsker = (game.turnAsker+1) % game.players.length;
  game.questionActive=false;
  game.current=null;
  questionLine.textContent="Kliknij „Losuj pytanie”, żeby wylosować pytanie dla kolejnej osoby.";
  renderHeader(); renderTurn();
}

function drawOrNext(){
  if(game.questionActive){ nextTurn(); return; }
  const q=drawOne();
  if(!q){
    questionLine.textContent="Skończyły się pytania. Kliknij „Reset pytań” albo „Nowa gra”.";
    mainBtn.disabled=true; otherBtn.disabled=true; copyBtn.disabled=true;
    return;
  }
  game.current=q;
  game.questionActive=true;
  questionLine.textContent=q.text;
  renderHeader(); renderTurn();
}

function otherQuestion(){
  if(!game.questionActive) return;
  const {targetIdx}=indices();
  const left=game.changesLeft[targetIdx] ?? 0;
  if(left<=0) return;

  game.changesLeft[targetIdx]-=1;

  const q=drawOne();
  if(!q){
    questionLine.textContent="Skończyły się pytania. Kliknij „Reset pytań” albo „Nowa gra”.";
    mainBtn.disabled=true; otherBtn.disabled=true; copyBtn.disabled=true;
    return;
  }
  game.current=q;
  questionLine.textContent=q.text;
  renderHeader(); renderTurn();
}

function copyCurrent(){
  if(!game.current) return;
  const {asker,target}=pair();
  const payload = `[${catLabel(game.current.catKey)}] ${asker} → ${target}: ${game.current.text}`;

  (navigator.clipboard?.writeText ? navigator.clipboard.writeText(payload) : Promise.reject())
    .then(()=>{ copyBtn.textContent="Skopiowano ✓"; setTimeout(()=>copyBtn.textContent="Kopiuj",900); })
    .catch(()=>{ const ta=document.createElement("textarea"); ta.value=payload; document.body.appendChild(ta); ta.select(); try{document.execCommand("copy")}catch{} document.body.removeChild(ta);
      copyBtn.textContent="Skopiowano ✓"; setTimeout(()=>copyBtn.textContent="Kopiuj",900); });
}

function resetQuestions(){
  game.usedCount=0;
  for(const k of game.lockedCats) refillBag(k);
  game.questionActive=false; game.current=null;
  mainBtn.disabled=false;
  questionLine.textContent="Pule pytań zresetowane. Kliknij „Losuj pytanie”.";
  renderHeader(); renderTurn();
}

function newGame(){
  setSection(true);
  up
  