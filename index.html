<!doctype html>
<html lang="pl">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>Rozmowy — gra w pytania (V2.1)</title>
  <style>
    :root{--bg:#0b1020;--card:#0f172a;--bar:#111827;--line:#243046;--text:#fff;--m:rgba(255,255,255,.75);--m2:rgba(255,255,255,.55);--good:#22c55e;--danger:#ef4444;}
    html,body{margin:0;height:100%;background:var(--bg);color:var(--text);font-family:system-ui}
    body{display:flex;justify-content:center}
    .app{width:100%;max-width:860px;min-height:100%;display:flex;flex-direction:column}
    header{padding:14px 16px;background:var(--bar);display:flex;align-items:center;justify-content:space-between;gap:12px}
    header .title{flex:1;text-align:center;line-height:1.15}
    header .title b{font-size:18px}
    header .title span{display:block;font-size:12px;opacity:.85}
    main{flex:1;display:flex;align-items:center;justify-content:center;padding:14px}
    .stack{width:100%;display:flex;flex-direction:column;gap:12px;align-items:center}
    .panel{width:100%;background:var(--card);border:1px solid var(--line);border-radius:18px;padding:14px}
    .sep{height:1px;background:var(--line);margin:12px 0}
    .center{text-align:center}
    .chips{display:flex;flex-wrap:wrap;gap:8px;justify-content:center}
    .chip{border:1px solid var(--line);background:#0b132b;color:var(--text);padding:9px 12px;border-radius:999px;font-weight:900;cursor:pointer}
    .chip.active{background:#1f2a44;border-color:#3b4a6a}
    .grid{display:grid;grid-template-columns:1fr;gap:8px;max-width:520px;width:100%;margin:0 auto}
    .label{font-size:12px;color:var(--m);text-align:left}
    select,input[type="text"]{width:100%;padding:12px;border-radius:12px;border:1px solid var(--line);background:#0b132b;color:var(--text);font-size:16px;outline:none}
    input::placeholder{color:var(--m2)}
    .row{display:flex;flex-wrap:wrap;gap:10px;align-items:center;justify-content:center}
    .btn{border:0;border-radius:16px;padding:12px 14px;font-weight:900;cursor:pointer;background:var(--good);color:#052e13}
    .btn.secondary{background:#0b132b;color:var(--text);border:1px solid var(--line)}
    .btn.danger{background:var(--danger);color:#fff}
    .btn.big{font-size:22px;padding:16px 18px;border-radius:18px;min-width:min(520px,100%)}
    .btn:disabled{opacity:.45;cursor:not-allowed}
    .hide{display:none!important}
    .card{width:100%;border:1px solid var(--line);border-radius:20px;padding:16px;min-height:170px;display:flex;flex-direction:column;gap:10px;justify-content:center;text-align:center;
      background:linear-gradient(180deg, rgba(255,255,255,.06), rgba(255,255,255,0));}
    .turn{font-size:14px;color:var(--m)}
    .question{font-size:22px;line-height:1.25}
    .small{font-size:12px;color:var(--m2);text-align:center}
    .badge{display:inline-block;font-weight:900;font-size:12px;padding:6px 10px;border-radius:999px;border:1px solid var(--line);background:#0b132b;color:var(--text)}
  </style>
</head>
<body>
<div class="app">
  <header>
    <div style="width:44px"></div>
    <div class="title">
      <b>Rozmowy <span class="badge">V2.1</span></b>
      <span>Gra w pytania • bez wygranych i przegranych</span>
    </div>
    <button class="btn secondary" id="newGameBtn">Nowa gra</button>
  </header>

  <main>
    <div class="stack">

      <section class="panel" id="setup">
        <div class="center">
          <h2 style="margin:0 0 6px 0">Ustawienia</h2>
          <div class="small">1) Wybierz kategorie • 2) Wpisz imiona • 3) Start</div>
        </div>

        <div class="sep"></div>

        <div class="center" style="margin-bottom:8px"><b>Kategorie w grze</b></div>
        <div class="chips" id="setupChips"></div>
        <div class="small" id="setupCatsMeta" style="margin-top:8px"></div>

        <div class="sep"></div>

        <div class="grid">
          <div class="label">Liczba graczy (2–20)</div>
          <select id="playerCount">
            <option>2</option><option>3</option><option>4</option><option>5</option><option>6</option>
            <option>7</option><option>8</option><option>9</option><option>10</option><option>11</option>
            <option>12</option><option>13</option><option>14</option><option>15</option><option>16</option>
            <option>17</option><option>18</option><option>19</option><option>20</option>
          </select>

          <div class="label" style="margin-top:6px">Imiona graczy (kolejność ma znaczenie)</div>
          <div id="playersGrid" class="grid"></div>

          <div class="row" style="margin-top:10px">
            <button class="btn big" id="startBtn" disabled>START</button>
          </div>

          <div class="small" id="startHint">
            Wpisz min. 2 imiona i wybierz przynajmniej 1 kategorię.
          </div>
        </div>
      </section>

      <section class="panel hide" id="play">
        <div class="center">
          <div class="small" id="lockedCatsLine"></div>
          <div class="small" id="poolLine"></div>
        </div>

        <div class="sep"></div>

        <div class="card">
          <div class="turn" id="turnLine">—</div>
          <div class="question" id="questionLine">Kliknij „Losuj pytanie”, żeby zacząć.</div>
          <div class="small" id="otherLine">—</div>
        </div>

        <div class="row" style="margin-top:12px">
          <button class="btn big" id="mainBtn">Losuj pytanie</button>
        </div>

        <div class="row">
          <button class="btn secondary" id="otherBtn" disabled>Inne pytanie</button>
          <button class="btn secondary" id="copyBtn" disabled>Kopiuj</button>
          <button class="btn danger" id="resetQuestionsBtn">Reset pytań</button>
        </div>

        <div class="small">Każdy gracz ma 2 zmiany pytania na CAŁĄ GRĘ (dla pytań kierowanych do niego).</div>
      </section>

    </div>
  </main>
</div>

<script>
(function(){
  function el(id){ return document.getElementById(id); }

  var setupSec = el("setup");
  var playSec  = el("play");

  var setupChips = el("setupChips");
  var setupCatsMeta = el("setupCatsMeta");
  var playerCountEl = el("playerCount");
  var playersGrid = el("playersGrid");
  var startBtn = el("startBtn");
  var startHint = el("startHint");

  var newGameBtn = el("newGameBtn");
  var lockedCatsLine = el("lockedCatsLine");
  var poolLine = el("poolLine");
  var turnLine = el("turnLine");
  var questionLine = el("questionLine");
  var otherLine = el("otherLine");
  var mainBtn = el("mainBtn");
  var otherBtn = el("otherBtn");
  var copyBtn = el("copyBtn");
  var resetQuestionsBtn = el("resetQuestionsBtn");

  var STEMS = [
    "Gdy myślisz o „{T}”, co jest dla Ciebie najtrudniejsze do powiedzenia na głos?",
    "W obszarze „{T}” — co w Tobie domaga się większej troski i dlaczego?",
    "W obszarze „{T}” — jaka Twoja potrzeba najczęściej nie jest zauważana?",
    "W obszarze „{T}” — co robisz automatycznie, a chciał(a)byś robić świadomie?",
    "W obszarze „{T}” — jaka jedna mała zmiana dałaby największą ulgę?",
    "W obszarze „{T}” — czego się boisz, że się stanie, jeśli będziesz szczery/szczera?",
    "W obszarze „{T}” — co jest Twoją siłą, a co cieniem tej samej cechy?",
    "W obszarze „{T}” — jak rozpoznajesz, że przekraczasz własne granice?",
    "W obszarze „{T}” — co dziś warto odpuścić, żeby odzyskać spokój?",
    "W obszarze „{T}” — jak wyglądałaby Twoja dojrzała reakcja w trudnej chwili?"
  ];

  var CATS = [
    { key:"relacje", label:"Relacje", themes:["zaufanie","granice","bliskość","komunikacja","konflikt","wsparcie","szacunek","zazdrość","intymność","wybaczenie"] },
    { key:"emocje", label:"Emocje", themes:["złość","smutek","lęk","wstyd","poczucie winy","radość","frustracja","bezradność","ulga","spokój"] },
    { key:"ja", label:"Ja (self)", themes:["wartości","tożsamość","samoocena","wewnętrzny krytyk","akceptacja","potrzeby","sprawczość","autentyczność","perfekcjonizm","odwaga"] },
    { key:"rozwoj", label:"Rozwój", themes:["nawyki","dyscyplina","cele","prokrastynacja","energia","nauka","porażka","cierpliwość","odpuszczanie","priorytety"] },
    { key:"rodzina", label:"Rodzina", themes:["komunikacja","role","granice","tradycje","konflikt","wsparcie","dzieciństwo","wzorce","emocje w domu","tematy tabu"] }
  ];

  function shuffle(arr){
    for (var i=arr.length-1;i>0;i--){
      var j=Math.floor(Math.random()*(i+1));
      var t=arr[i]; arr[i]=arr[j]; arr[j]=t;
    }
    return arr;
  }

  function buildBank(cat){
    var out=[];
    for (var i=0;i<cat.themes.length;i++){
      for (var s=0;s<STEMS.length;s++){
        out.push(STEMS[s].replace("{T}", cat.themes[i]));
      }
    }
    return shuffle(out); // 100
  }

  var setupState = { selectedCats: {} };
  for (var c=0;c<CATS.length;c++) setupState.selectedCats[CATS[c].key]=true;

  var game = {
    players: [],
    turnAsker: 0,
    questionActive: false,
    lockedCats: [],
    banks: {},
    bags: {},
    usedCount: 0,
    current: null,
    changesLeft: []
  };

  function setSection(isSetup){
    setupSec.classList.toggle("hide", !isSetup);
    playSec.classList.toggle("hide", isSetup);
  }

  function catLabel(key){
    for (var i=0;i<CATS.length;i++) if (CATS[i].key===key) return CATS[i].label;
    return key;
  }

  function updateSetupMeta(){
    var labels=[];
    for (var i=0;i<CATS.length;i++){
      if (setupState.selectedCats[CATS[i].key]) labels.push(CATS[i].label);
    }
    setupCatsMeta.textContent = labels.length ? ("Wybrane: " + labels.join(", ")) : "Wybierz przynajmniej jedną kategorię.";
  }

  function renderChips(){
    setupChips.innerHTML="";
    for (var i=0;i<CATS.length;i++){
      (function(cat){
        var b=document.createElement("button");
        b.className="chip active";
        b.textContent=cat.label;
        b.onclick=function(){
          setupState.selectedCats[cat.key]=!setupState.selectedCats[cat.key];
          b.classList.toggle("active", !!setupState.selectedCats[cat.key]);
          updateSetupMeta(); updateStartBtn();
        };
        setupChips.appendChild(b);
      })(CATS[i]);
    }
    updateSetupMeta();
  }

  function renderPlayers(){
    playersGrid.innerHTML="";
    var n = parseInt(playerCountEl.value,10) || 2;
    for (var i=0;i<n;i++){
      var wrap=document.createElement("div");
      wrap.innerHTML = '<div class="label">Gracz '+(i+1)+'</div><input type="text" id="p_'+i+'" placeholder="Imię (np. Łukasz)">';
      playersGrid.appendChild(wrap);
      wrap.querySelector("input").addEventListener("input", updateStartBtn);
    }
    updateStartBtn();
  }

  function getPlayers(){
    var n = parseInt(playerCountEl.value,10) || 2;
    var out=[];
    for (var i=0;i<n;i++){
      var v = (el("p_"+i).value || "").trim();
      if (v) out.push(v);
    }
    return out;
  }

  function selectedCatsArray(){
    var out=[];
    for (var i=0;i<CATS.length;i++){
      if (setupState.selectedCats[CATS[i].key]) out.push(CATS[i].key);
    }
    return out;
  }

  function updateStartBtn(){
    var players=getPlayers();
    var cats=selectedCatsArray();
    var okPlayers = players.length >= 2;
    var okCats = cats.length >= 1;
    startBtn.disabled = !(okPlayers && okCats);
    startHint.textContent = startBtn.disabled
      ? "Wpisz min. 2 imiona i wybierz przynajmniej 1 kategorię."
      : "Gotowe. Kliknij START.";
  }

  function refillBag(catKey){
    var n = game.banks[catKey].length;
    var bag=[];
    for (var i=0;i<n;i++) bag.push(i);
    game.bags[catKey]=shuffle(bag);
  }

  function remainingTotal(){
    var t=0;
    for (var i=0;i<game.lockedCats.length;i++){
      var k=game.lockedCats[i];
      t += (game.bags[k] ? game.bags[k].length : 0);
    }
    return t;
  }

  function activeCats(){
    var keys=[];
    for (var i=0;i<game.lockedCats.length;i++){
      var k=game.lockedCats[i];
      if (game.bags[k] && game.bags[k].length>0) keys.push(k);
    }
    return keys;
  }

  function drawOne(){
    var keys=activeCats();
    if (!keys.length) return null;
    var catKey = keys[Math.floor(Math.random()*keys.length)];
    var idx = game.bags[catKey].pop();
    game.usedCount += 1;
    return {catKey:catKey, idx:idx, text: game.banks[catKey][idx]};
  }

  function indices(){
    var askerIdx = game.turnAsker;
    var targetIdx = (game.turnAsker+1) % game.players.length;
    return {askerIdx:askerIdx, targetIdx:targetIdx};
  }

  function pair(){
    var ids=indices();
    return {asker: game.players[ids.askerIdx], target: game.players[ids.targetIdx], targetIdx: ids.targetIdx};
  }

  function renderHeader(){
    var labels=[];
    for (var i=0;i<game.lockedCats.length;i++) labels.push(catLabel(game.lockedCats[i]));
    lockedCatsLine.textContent = "Kategorie (zablokowane): " + labels.join(", ");
    poolLine.textContent = "Pozostało pytań: " + remainingTotal() + " • Wykorzystane: " + game.usedCount;
  }

  function renderTurn(){
    var p=pair();
    var left = game.changesLeft[p.targetIdx] || 0;
    turnLine.textContent = "Teraz: " + p.asker + " losuje pytanie dla " + p.target;
    otherLine.textContent = "Zmiany pytania dla " + p.target + ": " + left + "/2";

    otherBtn.textContent = "Inne pytanie ("+left+")";
    otherBtn.disabled = !game.questionActive || left<=0;
    copyBtn.disabled = !game.questionActive;

    mainBtn.textContent = game.questionActive ? "Następny gracz" : "Losuj pytanie";
  }

  function startGame(){
    var players=getPlayers();
    var cats=selectedCatsArray();
    if (players.length<2 || cats.length<1) return;

    game.players = players;
    game.turnAsker = 0;
    game.questionActive = false;
    game.lockedCats = cats;
    game.banks = {};
    game.bags = {};
    game.usedCount = 0;
    game.current = null;
    game.changesLeft = [];
    for (var i=0;i<players.length;i++) game.changesLeft.push(2);

    for (var i=0;i<cats.length;i++){
      var k=cats[i];
      for (var j=0;j<CATS.length;j++){
        if (CATS[j].key===k){
          game.banks[k]=buildBank(CATS[j]);
          refillBag(k);
        }
      }
    }

    setSection(false);
    mainBtn.disabled=false;
    questionLine.textContent="Kliknij „Losuj pytanie”, żeby zacząć.";
    renderHeader();
    renderTurn();
  }

  function nextTurn(){
    game.turnAsker = (game.turnAsker+1) % game.players.length;
    game.questionActive=false;
    game.current=null;
    questionLine.textContent="Kliknij „Losuj pytanie”, żeby wylosować pytanie dla kolejnej osoby.";
    renderHeader(); renderTurn();
  }

  function drawOrNext(){
    if(game.questionActive){ nextTurn(); return; }
    var q=drawOne();
    if(!q){
      questionLine.textContent="Skończyły się pytania. Kliknij „Reset pytań” albo „Nowa gra”.";
      mainBtn.disabled=true; otherBtn.disabled=true; copyBtn.disabled=true;
      return;
    }
    game.current=q;
    game.questionActive=true;
    questionLine.textContent=q.text;
    renderHeader(); renderTurn();
  }

  function otherQuestion(){
    if(!game.questionActive) return;
    var p=pair();
    var left = game.changesLeft[p.targetIdx] || 0;
    if(left<=0) return;
    game.changesLeft[p.targetIdx]=left-1;

    var q=drawOne();
    if(!q){
      questionLine.textContent="Skończyły się pytania. Kliknij „Reset pytań” albo „Nowa gra”.";
      mainBtn.disabled=true; otherBtn.disabled=true; copyBtn.disabled=true;
      return;
    }
    game.current=q;
    questionLine.textContent=q.text;
    renderHeader(); renderTurn();
  }

  function copyCurrent(){
    if(!game.current) return;
    var p=pair();
    var payload = "["+catLabel(game.current.catKey)+"] "+p.asker+" → "+p.target+": "+game.current.text;

    var ok = (navigator.clipboard && navigator.clipboard.writeText)
      ? navigator.clipboard.writeText(payload)
      : Promise.reject();

    ok.then(function(){
      copyBtn.textContent="Skopiowano ✓";
      setTimeout(function(){ copyBtn.textContent="Kopiuj"; }, 900);
    }).catch(function(){
      var ta=document.createElement("textarea");
      ta.value=payload;
      document.body.appendChild(ta);
      ta.select();
      try{document.execCommand("copy");}catch(e){}
      document.body.removeChild(ta);
      copyBtn.textContent="Skopiowano ✓";
      setTimeout(function(){ copyBtn.textContent="Kopiuj"; }, 900);
    });
  }

  function resetQuestions(){
    game.usedCount=0;
    for (var i=0;i<game.lockedCats.length;i++) refillBag(game.lockedCats[i]);
    game.questionActive=false; game.current=null;
    mainBtn.disabled=false;
    questionLine.textContent="Pule pytań zresetowane. Kliknij „Losuj pytanie”.";
    renderHeader(); renderTurn();
  }

  function newGame(){
    setSection(true);
    updateSetupMeta(); renderPlayers();
  }

  playerCountEl.value="2";
  renderChips();
  renderPlayers();
  setSection(true);

  playerCountEl.addEventListener("change", renderPlayers);
  startBtn.addEventListener("click", startGame);
  mainBtn.addEventListener("click", drawOrNext);
  otherBtn.addEventListener("click", otherQuestion);
  copyBtn.addEventListener("click", copyCurrent);
  resetQuestionsBtn.addEventListener("click", resetQuestions);
  newGameBtn.addEventListener("click", newGame);
})();
</script>
</body>
</html>
